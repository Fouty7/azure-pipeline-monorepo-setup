# Frontend API Pipeline - Monorepo Structure
# Supports GitFlow deployment strategy with PR validation and branch-based deployments

name: FrontendAPI-$(Date:yyyyMMdd)$(Rev:.r)

# PR Validation - runs on PRs to protected branches
pr:
  branches:
    include:
    - dev
    - qa
    - staging
    - main
  paths:
    include:
    - services/frontend-api/**
    - .pipeline-templates/**
    - shared/helm-charts/plain-app-chart/**

# CI/CD Trigger - runs when code is merged to these branches  
trigger:
  branches:
    include:
    - dev
    - qa
    - staging
    - main
  paths:
    include:
    - services/frontend-api/**
    - shared/helm-charts/plain-app-chart/**

pool:
  vmImage: 'ubuntu-latest'

variables:
  solutionName: 'FrontendApi'
  pathToSolutionFolder: 'services/frontend-api'
  buildContext: 'services/frontend-api'
  releaseName: 'frontend-api'
  serviceType: 'dotnet'
  acrUrl: 'mytestacr690.azurecr.io'  # UPDATE THIS
  acrServiceConnection: 'my-acr-connection'  # UPDATE THIS
  # Note: Environment-specific k8sConnection is passed via template parameters
  # k8sConnection is determined in stages based on Build.SourceBranch

stages:
# ============================================
# PR VALIDATION - Only runs for Pull Requests
# ============================================
- template: /.pipeline-templates/pr-validation-template.yml
  parameters:
    solutionName: $(solutionName)
    pathToSolutionFolder: $(pathToSolutionFolder)
    buildContext: $(buildContext)
    serviceType: $(serviceType)

# ============================================
# DEPLOYMENT - Only runs on branch merges
# ============================================
# Deploy to DEV (auto-deploy when merged to dev branch)
- template: /.pipeline-templates/environment-deployment-template.yml
  parameters:
    solutionName: $(solutionName)
    pathToSolutionFolder: $(pathToSolutionFolder)
    buildContext: $(buildContext)
    releaseName: $(releaseName)
    environment: 'dev'
    serviceType: $(serviceType)
    acrUrl: $(acrUrl)
    acrServiceConnection: $(acrServiceConnection)
    k8sServiceConnection: 'aks-dev-connection'  # UPDATE THIS
    requiresApproval: false

# Deploy to QA (auto-deploy when merged to qa branch)
- template: /.pipeline-templates/environment-deployment-template.yml
  parameters:
    solutionName: $(solutionName)
    pathToSolutionFolder: $(pathToSolutionFolder)
    buildContext: $(buildContext)
    releaseName: $(releaseName)
    environment: 'qa'
    serviceType: $(serviceType)
    acrUrl: $(acrUrl)
    acrServiceConnection: $(acrServiceConnection)
    k8sServiceConnection: 'aks-qa-connection'  # UPDATE THIS
    requiresApproval: false

# Deploy to STAGING (auto-deploy when merged to staging branch)
- template: /.pipeline-templates/environment-deployment-template.yml
  parameters:
    solutionName: $(solutionName)
    pathToSolutionFolder: $(pathToSolutionFolder)
    buildContext: $(buildContext)
    releaseName: $(releaseName)
    environment: 'staging'
    serviceType: $(serviceType)
    acrUrl: $(acrUrl)
    acrServiceConnection: $(acrServiceConnection)
    k8sServiceConnection: 'aks-staging-connection'  # UPDATE THIS
    requiresApproval: false

# Deploy to PRODUCTION (requires manual approval when merged to main branch)
- template: /.pipeline-templates/environment-deployment-template.yml
  parameters:
    solutionName: $(solutionName)
    pathToSolutionFolder: $(pathToSolutionFolder)
    buildContext: $(buildContext)
    releaseName: $(releaseName)
    environment: 'prod'
    serviceType: $(serviceType)
    acrUrl: $(acrUrl)
    acrServiceConnection: $(acrServiceConnection)
    k8sServiceConnection: 'aks-prod-connection'  # UPDATE THIS
    requiresApproval: true
